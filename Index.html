<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Interactivo de Yucatán</title>

    <!-- 1. Estilos de Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Estilos del plugin MarkerCluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.Default.css" />

    <!-- 2. Scripts de Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Script del plugin MarkerCluster -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.1/dist/leaflet.markercluster.js"></script>

    <!-- 3. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Estilos generales y de popups */
        .leaflet-popup-content-wrapper {
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .leaflet-popup-content {
            margin: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        body {
            background-color: #f7fafc; /* bg-gray-100 */
        }
        .category-btn.active {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
            font-weight: 700;
        }
        /* Estilos para el contenedor de sugerencias */
        #suggestions-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e2e8f0; /* border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            background-color: white;
        }
        .suggestion-item {
            padding: 0.5rem 0.75rem; /* px-3 py-2 */
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #f1f5f9; /* bg-slate-100 */
        }
    </style>
</head>
<body class="font-sans">

    <div class="container mx-auto p-4">
        <header class="text-center mb-4">
            <h1 class="text-3xl font-bold text-gray-800">Explora los Tesoros de Yucatán</h1>
            <p class="text-gray-500 mt-1">Selecciona una categoría o busca por nombre.</p>
        </header>

        <!-- Contenedor principal para el mapa y las categorías -->
        <main class="flex flex-col md:flex-row md:gap-6 md:h-[75vh]">

            <!-- Columna del Mapa -->
            <div id="map" class="w-full h-[350px] md:h-full rounded-xl shadow-lg"></div>

            <!-- Barra lateral de Categorías -->
            <aside class="w-full md:w-1/3 lg:w-1/4 mt-4 md:mt-0 p-4 bg-white rounded-xl shadow-lg flex flex-col gap-4">
                <div class="relative">
                    <h2 class="text-xl font-semibold text-center text-gray-700 mb-2">Buscar por Nombre</h2>
                    <input type="text" id="search-box" placeholder="Ej: Chichén Itzá..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500">
                    <div id="suggestions-container" class="absolute w-full z-10 mt-1 hidden"></div>
                </div>
                <div class="flex-grow">
                    <h2 class="text-xl font-semibold text-center text-gray-700 mb-2">Categorías</h2>
                    <div id="category-buttons" class="flex flex-col gap-3">
                        <button onclick="setCategory('todos', this)" class="category-btn w-full px-4 py-2.5 bg-sky-600 text-white font-semibold rounded-lg shadow-md hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-opacity-75 transition-all transform hover:scale-105">
                            Mostrar Todos
                        </button>
                        <button onclick="setCategory('cenote', this)" class="category-btn w-full px-4 py-2.5 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300 focus:ring-opacity-75 transition-all transform hover:scale-105">
                            Cenotes
                        </button>
                        <button onclick="setCategory('arqueologia', this)" class="category-btn w-full px-4 py-2.5 bg-amber-600 text-white font-semibold rounded-lg shadow-md hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-amber-400 focus:ring-opacity-75 transition-all transform hover:scale-105">
                            Zonas Arqueológicas
                        </button>
                        <button onclick="setCategory('hacienda', this)" class="category-btn w-full px-4 py-2.5 bg-emerald-600 text-white font-semibold rounded-lg shadow-md hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-400 focus:ring-opacity-75 transition-all transform hover:scale-105">
                            Haciendas
                        </button>
                    </div>
                </div>
            </aside>
        </main>
    </div>

<script>
    // --- LÓGICA DEL MAPA ---
    let allLocations = [];
    let activeCategory = 'todos';

    const map = L.map('map').setView([20.7, -89.0], 9);
    const categoryButtons = document.querySelectorAll('.category-btn');
    const searchBox = document.getElementById('search-box');
    const suggestionsContainer = document.getElementById('suggestions-container');

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);
    
    let markerLayer = L.markerClusterGroup();
    map.addLayer(markerLayer);

    function setCategory(category, clickedButton) {
        activeCategory = category;
        categoryButtons.forEach(btn => btn.classList.remove('active'));
        if (clickedButton) {
            clickedButton.classList.add('active');
        }
        filterAndShowLocations();
        updateSuggestions(); // Actualiza sugerencias al cambiar de categoría
    }

    function filterAndShowLocations() {
        const searchTerm = searchBox.value.toLowerCase();
        const categoryFiltered = allLocations.filter(loc => activeCategory === 'todos' || loc.category === activeCategory);
        const searchFiltered = categoryFiltered.filter(loc => loc.name.toLowerCase().includes(searchTerm));

        markerLayer.clearLayers();
        if (searchFiltered.length === 0) return;

        const markers = [];
        searchFiltered.forEach(location => {
            const marker = L.marker([location.lat, location.lng]);
            const popupContent = `
                <div class="w-64">
                    <a href="${location.url}" target="_blank" rel="noopener noreferrer">
                        <img src="${location.imageUrl}" alt="${location.name}" class="w-full h-32 object-cover rounded-t-lg transition-transform transform hover:scale-105">
                    </a>
                    <div class="p-3">
                        <a href="${location.url}" target="_blank" rel="noopener noreferrer" class="hover:underline">
                            <h3 class="text-lg font-bold text-gray-800">${location.name}</h3>
                        </a>
                        <p class="text-sm text-gray-600 mt-1">${location.description}</p>
                    </div>
                </div>
            `;
            marker.bindPopup(popupContent);
            markers.push(marker);
        });

        markerLayer.addLayers(markers);
        if (markers.length > 0 && searchTerm.length > 0) { // Solo haz zoom si hay un término de búsqueda activo
             map.fitBounds(markerLayer.getBounds(), { padding: [50, 50], maxZoom: 14 });
        }
    }

    function updateSuggestions() {
        const searchTerm = searchBox.value.toLowerCase();
        suggestionsContainer.innerHTML = '';

        if (searchTerm.length === 0) {
            suggestionsContainer.classList.add('hidden');
            return;
        }

        const categoryFiltered = allLocations.filter(loc => activeCategory === 'todos' || loc.category === activeCategory);
        const matchingLocations = categoryFiltered.filter(loc => loc.name.toLowerCase().includes(searchTerm));

        if (matchingLocations.length > 0) {
            suggestionsContainer.classList.remove('hidden');
            matchingLocations.forEach(location => {
                const item = document.createElement('div');
                item.classList.add('suggestion-item');
                item.textContent = location.name;
                item.onclick = () => {
                    searchBox.value = location.name;
                    suggestionsContainer.classList.add('hidden');
                    filterAndShowLocations();
                };
                suggestionsContainer.appendChild(item);
            });
        } else {
            suggestionsContainer.classList.add('hidden');
        }
    }

    // Cargar datos y luego inicializar el mapa
    document.addEventListener('DOMContentLoaded', () => {
        fetch('locations.json')
            .then(response => response.json())
            .then(data => {
                allLocations = data;
                
                searchBox.addEventListener('keyup', updateSuggestions);
                searchBox.addEventListener('search', filterAndShowLocations); // Para cuando se borra con la 'x'

                // Ocultar sugerencias si se hace clic fuera
                window.addEventListener('click', (e) => {
                    if (!searchBox.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                        suggestionsContainer.classList.add('hidden');
                    }
                });

                const firstButton = categoryButtons[0];
                setCategory('todos', firstButton);
                
                setTimeout(() => map.invalidateSize(), 100);
            })
            .catch(error => {
                console.error("Error al cargar las ubicaciones:", error);
            });
    });
</script>

</body>
</html>
