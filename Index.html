<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Interactivo de Yucatán</title>

    <!-- 1. Estilos de Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <!-- Estilos del plugin MarkerCluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.1/dist/MarkerCluster.Default.css" />

    <!-- 2. Scripts de Leaflet -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Script del plugin MarkerCluster -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.1/dist/leaflet.markercluster.js"></script>

    <!-- 3. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Estilos generales y de popups */
        .leaflet-popup-content-wrapper {
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .leaflet-popup-content {
            margin: 12px;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }
        body {
            background-color: #f7fafc; /* bg-gray-100 */
        }
        .category-btn.active {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
            font-weight: 700;
        }
        /* Estilos para el contenedor de sugerencias */
        #suggestions-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e2e8f0; /* border-gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            background-color: white;
        }
        .suggestion-item {
            padding: 0.5rem 0.75rem; /* px-3 py-2 */
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #f1f5f9; /* bg-slate-100 */
        }
    </style>
</head>
<body class="font-sans">

    <div class="container mx-auto p-4 h-screen flex flex-col">
        <header class="text-center mb-4" style="display: none;">
            <h2 class="text-3xl font-bold text-gray-800">Tesoros de la peninsula</h2>
            <p class="text-gray-500 mt-1">Selecciona una categoría o busca por nombre.</p>
        </header>

        <!-- Contenedor principal para el mapa y las categorías -->
        <main class="flex flex-col md:flex-row md:gap-6 md:h-[75vh]">

            <!-- Columna del Mapa -->
            <div id="map" class="w-full h-[350px] md:h-full rounded-xl shadow-lg"></div>

            <!-- Barra lateral de Categorías -->
            <aside class="w-full md:w-1/3 lg:w-1/4 mt-4 md:mt-0 p-4 bg-white rounded-xl shadow-lg flex flex-col gap-4">
                <div class="relative">
                    <h2 class="text-xl font-semibold text-center text-gray-700 mb-2">Buscar por nombre</h2>
                    <input type="text" id="search-box" placeholder="Ej: Chichén Itzá..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-sky-500">
                    <div id="suggestions-container" class="absolute w-full z-10 mt-1 hidden"></div>
                </div>
                <div class="flex-grow">
                    <h2 class="text-xl font-semibold text-center text-gray-700 mb-2">Categorías</h2>
                    <div id="category-container" class="flex flex-wrap justify-center gap-x-4 gap-y-2">
                        <label class="flex items-center space-x-3 cursor-pointer w-full border-b pb-2 mb-2">
                            <input type="checkbox" id="todos" class="h-5 w-5 rounded border-gray-300 text-sky-600 focus:ring-sky-500">
                            <span class="text-gray-800 font-medium">Mostrar Todos</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" name="category" value="cenote" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-gray-700">Cenotes</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" name="category" value="arqueologia" class="h-5 w-5 rounded border-gray-300 text-amber-600 focus:ring-amber-500">
                            <span class="text-gray-700">Zonas Arqueológicas</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" name="category" value="hacienda" class="h-5 w-5 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500">
                            <span class="text-gray-700">Haciendas</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" name="category" value="playa" class="h-5 w-5 rounded border-gray-300 text-teal-600 focus:ring-teal-500">
                            <span class="text-gray-700">Playas</span>
                        </label>
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" name="category" value="catedral" class="h-5 w-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <span class="text-gray-700">Catedrales</span>
                        </label>
                    </div>
                </div>
            </aside>
        </main>
    </div>

<script>
    // --- LÓGICA DEL MAPA ---
    let allLocations = [];
    
    const map = L.map('map', {
        zoomControl: false // Desactiva el control de zoom por defecto
    }).setView([20.7, -89.0], 9);

    L.control.zoom({ position: 'bottomleft' }).addTo(map);
    
    const searchBox = document.getElementById('search-box');
    const suggestionsContainer = document.getElementById('suggestions-container');
    const categoryCheckboxes = document.querySelectorAll('input[name="category"]');
    const todosCheckbox = document.getElementById('todos');

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);
    
    let markerLayer = L.markerClusterGroup({ removeOutsideVisibleBounds: false });
    map.addLayer(markerLayer);

    function getSelectedCategories() {
        const selected = [];
        categoryCheckboxes.forEach(checkbox => {
            if (checkbox.checked) {
                selected.push(checkbox.value);
            }
        });
        return selected;
    }

    function filterAndShowLocations() {
        const searchTerm = searchBox.value.toLowerCase();
        const activeCategories = getSelectedCategories();
        
        // Si ninguna categoría individual está seleccionada, mostramos todo.
        const categoryFiltered = activeCategories.length === 0
            ? allLocations
            : allLocations.filter(loc => activeCategories.includes(loc.category));

        const searchFiltered = categoryFiltered.filter(loc => loc.name.toLowerCase().includes(searchTerm));

        markerLayer.clearLayers();
        if (searchFiltered.length === 0) {
            return;
        }

        const markers = [];
        searchFiltered.forEach(location => {
            const marker = L.marker([location.lat, location.lng]);
            const popupContent = `
                <div class="w-64">
                    <a href="${location.url}" target="_blank" rel="noopener noreferrer">
                        <img src="${location.imageUrl}" alt="${location.name}" class="w-full h-32 object-cover rounded-t-lg transition-transform transform hover:scale-105">
                    </a>
                    <div class="p-3">
                        <a href="${location.url}" target="_blank" rel="noopener noreferrer" class="hover:underline">
                            <h3 class="text-lg font-bold text-gray-800">${location.name}</h3>
                        </a>
                        <p class="text-sm text-gray-600 mt-1">${location.description}</p>
                    </div>
                </div>
            `;
            marker.bindPopup(popupContent);
            markers.push(marker);
        });

        markerLayer.addLayers(markers);

        if (markers.length > 1) {
            const bounds = markerLayer.getBounds();
            if (bounds.isValid()) {
                 map.fitBounds(bounds, { padding: [50, 50], maxZoom: 14 });
            }
        } else if (markers.length === 1) {
            map.setView(markers[0].getLatLng(), 14);
            markers[0].openPopup();
        }
    }

    function updateSuggestions() {
        const searchTerm = searchBox.value.toLowerCase();
        suggestionsContainer.innerHTML = '';

        if (searchTerm.length === 0) {
            suggestionsContainer.classList.add('hidden');
            return;
        }

        const activeCategories = getSelectedCategories();
        const categoryFiltered = activeCategories.length === 0
            ? allLocations
            : allLocations.filter(loc => activeCategories.includes(loc.category));
        const matchingLocations = categoryFiltered.filter(loc => loc.name.toLowerCase().includes(searchTerm));

        if (matchingLocations.length > 0) {
            suggestionsContainer.classList.remove('hidden');
            matchingLocations.forEach(location => {
                const item = document.createElement('div');
                item.classList.add('suggestion-item');
                item.textContent = location.name;
                item.onclick = () => {
                    searchBox.value = location.name;
                    suggestionsContainer.classList.add('hidden');
                    filterAndShowLocations();
                };
                suggestionsContainer.appendChild(item);
            });
        } else {
            suggestionsContainer.classList.add('hidden');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetch('locations.json')
            .then(response => response.json())
            .then(data => {
                allLocations = Object.values(data).flat();
                
                searchBox.addEventListener('keyup', updateSuggestions);
                searchBox.addEventListener('search', filterAndShowLocations);

                categoryCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', () => {
                        const allChecked = [...categoryCheckboxes].every(c => c.checked);
                        const someChecked = [...categoryCheckboxes].some(c => c.checked);
                        
                        todosCheckbox.indeterminate = someChecked && !allChecked;
                        todosCheckbox.checked = allChecked;

                        // Si no hay nada seleccionado, filtramos para mostrar todo
                        if (!someChecked) {
                            filterAndShowLocations(); // Llama a filter que usará allLocations
                        } else {
                            filterAndShowLocations();
                        }
                        updateSuggestions();
                    });
                });

                todosCheckbox.addEventListener('change', () => {
                    categoryCheckboxes.forEach(checkbox => {
                        checkbox.checked = todosCheckbox.checked;
                    });
                    todosCheckbox.indeterminate = false;
                    filterAndShowLocations();
                    updateSuggestions();
                });

                window.addEventListener('click', (e) => {
                    if (!searchBox.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                        suggestionsContainer.classList.add('hidden');
                    }
                });

                // Por defecto, no mostrar ninguna categoría individualmente, pero sí todas en el mapa.
                filterAndShowLocations();
                
                setTimeout(() => map.invalidateSize(), 100);
            })
            .catch(error => {
                console.error("Error al cargar las ubicaciones:", error);
            });
    });
</script>

</body>
</html>